machine:
  services:
    - docker

dependencies:
  override:
    - docker info
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - docker build --rm=false -t "deephire/backend:$CIRCLE_BUILD_NUM" .
    - pip install awscli

test:
  override:
    - docker run -p 3001:3001 -e AUTH0_DOMAIN=$AUTH0_DOMAIN -e API_ID=$API_ID -e SENDGRID_API_KEY=$SENDGRID_API_KEY "deephire/backend:$CIRCLE_BUILD_NUM" pytest 
    - docker run -d -p 3001:3001 -e AUTH0_DOMAIN=$AUTH0_DOMAIN -e API_ID=$API_ID -e SENDGRID_API_KEY=$SENDGRID_API_KEY "deephire/backend:$CIRCLE_BUILD_NUM"; sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost:3001/ping
    



  

deployment:
  hub:
    branch: develop
    commands:
      - docker push "deephire/backend:$CIRCLE_BUILD_NUM"
      - sed -i'' -e "s;%BUILD_NUM%;$CIRCLE_BUILD_NUM;g" ./.deploy/Dockerrun.aws.json
      - cd .deploy && eb deploy -l $CIRCLE_BUILD_NUM --profile default